<script>
// Runs in the top page (any injected snippet/file)
function iframeFetch(iframeEl, url, init = {}, targetOrigin = "*", timeoutMs = 15000) {
  if (!iframeEl || !iframeEl.contentWindow) {
    return Promise.reject(new Error("iframe not available"));
  }

  return new Promise((resolve, reject) => {
    const channel = new MessageChannel();
    const timer = setTimeout(() => {
      channel.port1.close();
      reject(new Error("iframeFetch timeout"));
    }, timeoutMs);

    channel.port1.onmessage = (ev) => {
      clearTimeout(timer);
      channel.port1.close();
      resolve(ev.data);
    };

    iframeEl.contentWindow.postMessage({
      type: "IFRAME_FETCH_REQ",
      payload: { url, init }
    }, targetOrigin, [channel.port2]);
  });
}

// Helper to locate your specific iframe.
// Example strategies: by selector, by name, or by origin.
function findTargetIframeByOrigin(origin) {
  const iframes = Array.from(document.querySelectorAll("iframe[src]"));
  return iframes.find(f => {
    try {
      return new URL(f.src, location.href).origin === origin;
    } catch { return false; }
  }) || null;
}


  iframeFetch(apiFrame, "/api/me", { method: "GET" }, "https://your-iframe-origin.example.com")
    .then(res => {
      if (!res.ok) throw new Error(res.error || `HTTP ${res.status}`);
      console.log("IFRAME RESPONSE:", res.body);
    })
    .catch(err => console.error("IFRAME FETCH FAILED:", err));

</script>